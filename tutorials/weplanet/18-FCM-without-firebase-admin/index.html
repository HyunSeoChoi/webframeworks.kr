<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<style>
@import url(https://fonts.googleapis.com/earlyaccess/nanumgothic.css); /* 나눔고딕 : 'Nanum Gothic' */
</style>
<title>WebFrameworks.kr - AWS Severless IoT 18 – FCM without Firebase-admin</title>
<link rel="stylesheet" href="/static/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/syntax.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/static/css/toc.css">
    <script type="text/javascript" src="/static/js/jquery.toc.js"></script>
</head>
<body>
<nav class="navbar navbar-default top_menu" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">웹Frameworks</a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/getstarted">Get Started</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/updates">Update</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/tutorials">Tutorials</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/quickstart">Quick Start</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/archives">Archives</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="https://github.com/KoreaHTML5/webframeworks.kr/blob/master/CONTRIBUTE.md" target="_blank">참여하기</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="http://goo.gl/forms/MB9ZxVvdrD" target="_blank">설문하기</a></li>
            </ul>
        </div>
    </div>
</nav>


<div class="content_bg"  style="background-color: #;color: #;" >
<div class="col-md-10 col-md-offset-1 title_header jumbotron"  style="background:url() no-repeat center"  >
<h1 class="title_header_title">AWS Severless IoT 18 – FCM without Firebase-admin</h1>
<p class="title_header_summary">AWS Severless IoT에 대해 알아봅니다.</p>
</div>
</div>

<div>

    <div class="col-sm-3 col-md-2 col-md-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">작성자</h3>
            </div>
            <div class="panel-body">
                <div class="media">
                    <a class="pull-left" href="#">
                        <img class="media-object profile_img" src="https://avatars1.githubusercontent.com/u/2949778?s=400&v=4" alt="홍세민">
                    </a>
                    <div class="media-body">
                        <h4 class="media-heading">
                            홍세민

                        </h4>
                        MarcusHong<br>
                    </div>
                </div>
            </div>
        </div>

        <div id="toc_location"></div>

        <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Tags</h3>
    </div>
    <div class="panel-body">
        <a href='/tags/jquery/' style='color: rgba(0,0,0,0.059761)'>jquery</a>
<a href='/tags/javascript/' style='color: rgba(0,0,0,10.996016)'>javascript</a>
<a href='/tags/html/' style='color: rgba(0,0,0,0.059761)'>html</a>
<a href='/tags/grunt/' style='color: rgba(0,0,0,0.059761)'>grunt</a>
<a href='/tags/gulp/' style='color: rgba(0,0,0,0.059761)'>gulp</a>
<a href='/tags/build/' style='color: rgba(0,0,0,0.418327)'>build</a>
<a href='/tags/yeoman/' style='color: rgba(0,0,0,0.059761)'>yeoman</a>
<a href='/tags/foundation/' style='color: rgba(0,0,0,0.059761)'>foundation</a>
<a href='/tags/bower/' style='color: rgba(0,0,0,0.119522)'>bower</a>
<a href='/tags/twitter/' style='color: rgba(0,0,0,0.119522)'>twitter</a>
<a href='/tags/framework/' style='color: rgba(0,0,0,2.450199)'>framework</a>
<a href='/tags/angularjs/' style='color: rgba(0,0,0,1.015936)'>angularjs</a>
<a href='/tags/tutorials/' style='color: rgba(0,0,0,1.314741)'>tutorials</a>
<a href='/tags/backbone/' style='color: rgba(0,0,0,0.239044)'>backbone</a>
<a href='/tags/getstarted/' style='color: rgba(0,0,0,0.179283)'>getstarted</a>
<a href='/tags/underscore/' style='color: rgba(0,0,0,0.059761)'>underscore</a>
<a href='/tags/library/' style='color: rgba(0,0,0,0.418327)'>library</a>
<a href='/tags/Ext/' style='color: rgba(0,0,0,0.537849)'>Ext</a>
<a href='/tags/JS/' style='color: rgba(0,0,0,0.836653)'>JS</a>
<a href='/tags/tutorial/' style='color: rgba(0,0,0,0.776892)'>tutorial</a>
<a href='/tags/modernizr/' style='color: rgba(0,0,0,0.059761)'>modernizr</a>
<a href='/tags/bootstrap/' style='color: rgba(0,0,0,0.179283)'>bootstrap</a>
<a href='/tags/quickstart/' style='color: rgba(0,0,0,0.059761)'>quickstart</a>
<a href='/tags/angular-di/' style='color: rgba(0,0,0,0.059761)'>angular-di</a>
<a href='/tags/animation/' style='color: rgba(0,0,0,0.239044)'>animation</a>
<a href='/tags/router/' style='color: rgba(0,0,0,0.059761)'>router</a>
<a href='/tags/promise/' style='color: rgba(0,0,0,0.298805)'>promise</a>
<a href='/tags/responsive/' style='color: rgba(0,0,0,0.059761)'>responsive</a>
<a href='/tags/form/' style='color: rgba(0,0,0,0.119522)'>form</a>
<a href='/tags/validation/' style='color: rgba(0,0,0,0.119522)'>validation</a>
<a href='/tags/map/' style='color: rgba(0,0,0,0.059761)'>map</a>
<a href='/tags/direcitve/' style='color: rgba(0,0,0,0.059761)'>direcitve</a>
<a href='/tags/file/' style='color: rgba(0,0,0,0.119522)'>file</a>
<a href='/tags/test/' style='color: rgba(0,0,0,0.239044)'>test</a>
<a href='/tags/ui-bootstrap/' style='color: rgba(0,0,0,0.059761)'>ui-bootstrap</a>
<a href='/tags/twitter-bootstrap/' style='color: rgba(0,0,0,0.059761)'>twitter-bootstrap</a>
<a href='/tags/d3.js/' style='color: rgba(0,0,0,0.059761)'>d3.js</a>
<a href='/tags/visualization/' style='color: rgba(0,0,0,0.358566)'>visualization</a>
<a href='/tags/expressjs/' style='color: rgba(0,0,0,0.418327)'>expressjs</a>
<a href='/tags/react/' style='color: rgba(0,0,0,1.792829)'>react</a>
<a href='/tags/session/' style='color: rgba(0,0,0,0.179283)'>session</a>
<a href='/tags/meteor/' style='color: rgba(0,0,0,0.836653)'>meteor</a>
<a href='/tags/SEO/' style='color: rgba(0,0,0,0.059761)'>SEO</a>
<a href='/tags/REST/' style='color: rgba(0,0,0,0.059761)'>REST</a>
<a href='/tags/API/' style='color: rgba(0,0,0,0.059761)'>API</a>
<a href='/tags/es2015/' style='color: rgba(0,0,0,0.119522)'>es2015</a>
<a href='/tags/es6/' style='color: rgba(0,0,0,0.657371)'>es6</a>
<a href='/tags/es7/' style='color: rgba(0,0,0,0.119522)'>es7</a>
<a href='/tags/DDP/' style='color: rgba(0,0,0,0.059761)'>DDP</a>
<a href='/tags/ngMessages/' style='color: rgba(0,0,0,0.119522)'>ngMessages</a>
<a href='/tags/jsx/' style='color: rgba(0,0,0,0.059761)'>jsx</a>
<a href='/tags/publish/' style='color: rgba(0,0,0,0.059761)'>publish</a>
<a href='/tags/subscribe/' style='color: rgba(0,0,0,0.059761)'>subscribe</a>
<a href='/tags/meteor.js/' style='color: rgba(0,0,0,0.059761)'>meteor.js</a>
<a href='/tags/node.js/' style='color: rgba(0,0,0,0.239044)'>node.js</a>
<a href='/tags/backend/' style='color: rgba(0,0,0,0.179283)'>backend</a>
<a href='/tags/reactive/' style='color: rgba(0,0,0,0.059761)'>reactive</a>
<a href='/tags/package/' style='color: rgba(0,0,0,0.059761)'>package</a>
<a href='/tags/static/' style='color: rgba(0,0,0,0.059761)'>static</a>
<a href='/tags/assets/' style='color: rgba(0,0,0,0.059761)'>assets</a>
<a href='/tags/public/' style='color: rgba(0,0,0,0.059761)'>public</a>
<a href='/tags/flux/' style='color: rgba(0,0,0,0.239044)'>flux</a>
<a href='/tags/redux/' style='color: rgba(0,0,0,0.418327)'>redux</a>
<a href='/tags/server/' style='color: rgba(0,0,0,0.059761)'>server</a>
<a href='/tags/distribution/' style='color: rgba(0,0,0,0.059761)'>distribution</a>
<a href='/tags/webpack/' style='color: rgba(0,0,0,0.239044)'>webpack</a>
<a href='/tags/development/' style='color: rgba(0,0,0,0.059761)'>development</a>
<a href='/tags/optimization/' style='color: rgba(0,0,0,0.059761)'>optimization</a>
<a href='/tags/immutable/' style='color: rgba(0,0,0,0.059761)'>immutable</a>
<a href='/tags/orm/' style='color: rgba(0,0,0,0.239044)'>orm</a>
<a href='/tags/database/' style='color: rgba(0,0,0,0.239044)'>database</a>
<a href='/tags/hapi.js/' style='color: rgba(0,0,0,0.059761)'>hapi.js</a>
<a href='/tags/hapi/' style='color: rgba(0,0,0,0.239044)'>hapi</a>
<a href='/tags/ionic/' style='color: rgba(0,0,0,0.119522)'>ionic</a>
<a href='/tags/hybrid-app/' style='color: rgba(0,0,0,0.059761)'>hybrid-app</a>
<a href='/tags/django/' style='color: rgba(0,0,0,0.059761)'>django</a>
<a href='/tags/fullstack/' style='color: rgba(0,0,0,0.059761)'>fullstack</a>
<a href='/tags/spa/' style='color: rgba(0,0,0,0.059761)'>spa</a>
<a href='/tags/ExpressJS/' style='color: rgba(0,0,0,0.298805)'>ExpressJS</a>
<a href='/tags/NodeJS/' style='color: rgba(0,0,0,0.298805)'>NodeJS</a>
<a href='/tags/Sequelize/' style='color: rgba(0,0,0,0.298805)'>Sequelize</a>
<a href='/tags/Mocha/' style='color: rgba(0,0,0,0.298805)'>Mocha</a>
<a href='/tags/Supertest/' style='color: rgba(0,0,0,0.298805)'>Supertest</a>
<a href='/tags/UnitTest/' style='color: rgba(0,0,0,0.298805)'>UnitTest</a>
<a href='/tags/reactjs/' style='color: rgba(0,0,0,0.179283)'>reactjs</a>
<a href='/tags/this/' style='color: rgba(0,0,0,0.119522)'>this</a>
<a href='/tags/dom/' style='color: rgba(0,0,0,0.059761)'>dom</a>
<a href='/tags/es5/' style='color: rgba(0,0,0,0.119522)'>es5</a>
<a href='/tags/virtualdom/' style='color: rgba(0,0,0,0.119522)'>virtualdom</a>
<a href='/tags/modules/' style='color: rgba(0,0,0,0.059761)'>modules</a>
<a href='/tags/asynchronous/' style='color: rgba(0,0,0,0.059761)'>asynchronous</a>
<a href='/tags/semicolon/' style='color: rgba(0,0,0,0.059761)'>semicolon</a>
<a href='/tags/nodejs/' style='color: rgba(0,0,0,0.119522)'>nodejs</a>
<a href='/tags/ECMAScript2015/' style='color: rgba(0,0,0,0.119522)'>ECMAScript2015</a>
<a href='/tags/babel/' style='color: rgba(0,0,0,0.059761)'>babel</a>
<a href='/tags/angular,/' style='color: rgba(0,0,0,0.059761)'>angular,</a>
<a href='/tags/electron/' style='color: rgba(0,0,0,0.119522)'>electron</a>
<a href='/tags/docker/' style='color: rgba(0,0,0,0.478088)'>docker</a>
<a href='/tags/D3/' style='color: rgba(0,0,0,0.059761)'>D3</a>
<a href='/tags/node/' style='color: rgba(0,0,0,0.119522)'>node</a>
<a href='/tags/express/' style='color: rgba(0,0,0,0.119522)'>express</a>
<a href='/tags/aws/' style='color: rgba(0,0,0,1.613546)'>aws</a>
<a href='/tags/dynamoDB/' style='color: rgba(0,0,0,0.059761)'>dynamoDB</a>
<a href='/tags/chrome/' style='color: rgba(0,0,0,0.059761)'>chrome</a>
<a href='/tags/native/' style='color: rgba(0,0,0,0.119522)'>native</a>
<a href='/tags/markdown/' style='color: rgba(0,0,0,0.059761)'>markdown</a>
<a href='/tags/vue/' style='color: rgba(0,0,0,2.211155)'>vue</a>
<a href='/tags/middleware/' style='color: rgba(0,0,0,0.119522)'>middleware</a>
<a href='/tags/IoT/' style='color: rgba(0,0,0,0.059761)'>IoT</a>
<a href='/tags/serverless/' style='color: rgba(0,0,0,0.537849)'>serverless</a>
<a href='/tags/python/' style='color: rgba(0,0,0,0.179283)'>python</a>
<a href='/tags/socket.io/' style='color: rgba(0,0,0,0.179283)'>socket.io</a>
<a href='/tags/typescript/' style='color: rgba(0,0,0,0.059761)'>typescript</a>
<a href='/tags/laravel/' style='color: rgba(0,0,0,1.553785)'>laravel</a>
<a href='/tags/express.js/' style='color: rgba(0,0,0,0.059761)'>express.js</a>
<a href='/tags/next/' style='color: rgba(0,0,0,0.059761)'>next</a>
<a href='/tags/nuxt/' style='color: rgba(0,0,0,0.059761)'>nuxt</a>
<a href='/tags/java/' style='color: rgba(0,0,0,0.059761)'>java</a>
<a href='/tags/spring/' style='color: rgba(0,0,0,0.059761)'>spring</a>
<a href='/tags/github/' style='color: rgba(0,0,0,0.119522)'>github</a>
<a href='/tags/slack/' style='color: rgba(0,0,0,0.119522)'>slack</a>
<a href='/tags/react-native/' style='color: rgba(0,0,0,0.059761)'>react-native</a>
<a href='/tags/data/' style='color: rgba(0,0,0,0.298805)'>data</a>
<a href='/tags/opensource/' style='color: rgba(0,0,0,0.059761)'>opensource</a>
<a href='/tags/pwa/' style='color: rgba(0,0,0,0.059761)'>pwa</a>
<a href='/tags/php/' style='color: rgba(0,0,0,0.059761)'>php</a>
<a href='/tags/vuejs/' style='color: rgba(0,0,0,0.597610)'>vuejs</a>
<a href='/tags/nextjs/' style='color: rgba(0,0,0,0.478088)'>nextjs</a>
<a href='/tags/react_admin/' style='color: rgba(0,0,0,0.179283)'>react_admin</a>
<a href='/tags/webrtc/' style='color: rgba(0,0,0,0.239044)'>webrtc</a>
<a href='/tags/cd/' style='color: rgba(0,0,0,0.059761)'>cd</a>
<a href='/tags/pm2/' style='color: rgba(0,0,0,0.059761)'>pm2</a>
<a href='/tags/docker_registry/' style='color: rgba(0,0,0,0.059761)'>docker_registry</a>
<a href='/tags/ecr/' style='color: rgba(0,0,0,0.059761)'>ecr</a>
<a href='/tags/twilio/' style='color: rgba(0,0,0,0.059761)'>twilio</a>
<a href='/tags/json_schema/' style='color: rgba(0,0,0,0.059761)'>json_schema</a>
<a href='/tags/sql/' style='color: rgba(0,0,0,0.059761)'>sql</a>
<a href='/tags/json/' style='color: rgba(0,0,0,0.059761)'>json</a>
<a href='/tags/web/' style='color: rgba(0,0,0,0.059761)'>web</a>
<a href='/tags/sdk/' style='color: rgba(0,0,0,0.059761)'>sdk</a>
<a href='/tags/ssl/' style='color: rgba(0,0,0,0.059761)'>ssl</a>
<a href='/tags/portainer/' style='color: rgba(0,0,0,0.059761)'>portainer</a>
<a href='/tags/jwt/' style='color: rgba(0,0,0,0.059761)'>jwt</a>
<a href='/tags/mailu/' style='color: rgba(0,0,0,0.059761)'>mailu</a>
<a href='/tags/sam/' style='color: rgba(0,0,0,0.059761)'>sam</a>
<a href='/tags/lambda/' style='color: rgba(0,0,0,0.059761)'>lambda</a>
<a href='/tags/thumbnail/' style='color: rgba(0,0,0,0.059761)'>thumbnail</a>
<a href='/tags/redis/' style='color: rgba(0,0,0,0.059761)'>redis</a>
<a href='/tags/hyperledger/' style='color: rgba(0,0,0,0.418327)'>hyperledger</a>
<a href='/tags/fabric/' style='color: rgba(0,0,0,0.418327)'>fabric</a>

    </div>
</div>
    </div>

    <div class="col-sm-9 col-md-6">
        <div class="media_content media_item shadow_panel" id="main_content">
            <h3>Push Notification</h3>

<p>소켓으로 메세지를 보낼 수 있게 되었으니, 이제 유저가 접속을 하지 않았을 경우에 Push를 보내는 일만 남았다.
AWS SNS는 아직 FCM을 지원하지 않고 있고, AWS Pinpoint는 과금이 SNS의 두배이기 때문에 부담스럽다.
따라서 무료인 firebase를 사용하는 것이 대안인데, firebase admin sdk를 사용하게 되면 Lambda 함수의 용량이 너무 커지는 문제가 있다.
axios를 통해 http request로 처리하게 되면 용량에 문제없이 처리할 수 있다.</p>

<h3>Cloudformation</h3>

<ul>
<li>앞서 만들었던 PrivateApisV1에 환경변수를 추가한다.</li>
<li>Firebase에 프로젝트를 생성하고 생성된 서버키를 추가한다.</li>
</ul>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">Resource</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">PrivateApisV1</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">Type</span><span class="p-Indicator">:</span> <span class="s">&#39;AWS::Serverless::Function&#39;</span>
    <span class="l-Scalar-Plain">Properties</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">CodeUri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src</span>
      <span class="l-Scalar-Plain">Handler</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bin/lambda.handler</span>
      <span class="l-Scalar-Plain">Runtime</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nodejs6.10</span>
      <span class="l-Scalar-Plain">Role</span><span class="p-Indicator">:</span>
        <span class="s">&#39;Fn::GetAtt&#39;</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BasicExecutionRole</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Arn</span>
      <span class="l-Scalar-Plain">Environment</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Variables</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">IOTEndPoint</span><span class="p-Indicator">:</span>
            <span class="s">&#39;endpoint&#39;</span>
          <span class="l-Scalar-Plain">IotAccessPolicy</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">Ref</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IotAccessPolicy</span>
          <span class="l-Scalar-Plain">FirebaseServerKey</span><span class="p-Indicator">:</span>
            <span class="s">&#39;serverKey&#39;</span>
      <span class="l-Scalar-Plain">Timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">VpcConfig</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">SecurityGroupIds</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Ref</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">VPCLambdaSecurityGroup</span>
        <span class="l-Scalar-Plain">SubnetIds</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Ref</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">PublicSubnetA</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Ref</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">PublicSubnetB</span>
      <span class="l-Scalar-Plain">Events</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">ProxyApiRoot</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">Type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Api</span>
          <span class="l-Scalar-Plain">Properties</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">RestApiId</span><span class="p-Indicator">:</span>
              <span class="l-Scalar-Plain">Ref</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ApiGatewayApi</span>
            <span class="l-Scalar-Plain">Path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/v1</span>
            <span class="l-Scalar-Plain">Method</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ANY</span>
        <span class="l-Scalar-Plain">ProxyApiGreedy</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">Type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Api</span>
          <span class="l-Scalar-Plain">Properties</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">RestApiId</span><span class="p-Indicator">:</span>
              <span class="l-Scalar-Plain">Ref</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ApiGatewayApi</span>
            <span class="l-Scalar-Plain">Path</span><span class="p-Indicator">:</span> <span class="s">&#39;/v1/{proxy+}&#39;</span>
            <span class="l-Scalar-Plain">Method</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ANY</span>
</code></pre></div>
<h3>express.js</h3>

<ul>
<li>Push Count를 위해 count 개수별로 구분해서 Push Notification을 보낸다.</li>
</ul>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">axios</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">asFcmRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;https://fcm.googleapis.com/fcm/send&#39;</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">Authorization</span><span class="o">:</span> <span class="s1">&#39;key=&#39;</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FirebaseServerKey</span><span class="p">,</span>
      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="p">},</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">options</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">sendChatMessage</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">users</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">users</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">pushCount</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">pushCount</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">pushCount</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">user</span><span class="p">]</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">ret</span>
    <span class="p">},</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">count</span> <span class="nx">of</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">arr</span><span class="p">))</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">newPayload</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">payload</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">count</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">i</span> <span class="o">=&gt;</span> <span class="nx">i</span><span class="p">.</span><span class="nx">fcmToken</span><span class="p">)</span>
      <span class="nx">newPayload</span><span class="p">.</span><span class="nx">badge</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span>
      <span class="nx">await</span> <span class="nx">asFcmRequest</span><span class="p">({</span>
        <span class="nx">registration_ids</span><span class="o">:</span> <span class="nx">tokens</span><span class="p">,</span>
        <span class="nx">priority</span><span class="o">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
        <span class="nx">notification</span><span class="o">:</span> <span class="nx">newPayload</span><span class="p">.</span><span class="nx">notification</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">newPayload</span><span class="p">.</span><span class="nx">data</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nx">err</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
        </div>

        <div class="media_content media_item shadow_panel">
            <p>Tags : <a href="/tags/aws">aws</a>&nbsp;</p>
        </div>


        <div class="media_content media_item shadow_panel">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'html5krforkisa'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
        </div>

    </div>

    <script>
        $('#main_content').toc();
    </script>
</div>
<footer>
<table width="100%" height="80" class="footer">
    <tr>
        <td align="center" class="footer_content">
            WebFrameworks.kr @since 2015
        </td>
    </tr>
</table>
</footer>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56520981-1', 'auto');
    ga('send', 'pageview');

</script>
</body>
</html>