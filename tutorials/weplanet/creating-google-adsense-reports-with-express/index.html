<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<style>
@import url(https://fonts.googleapis.com/earlyaccess/nanumgothic.css); /* 나눔고딕 : 'Nanum Gothic' */
</style>
<title>WebFrameworks.kr - Express로 Google AdSense 보고서 작성하기</title>
<link rel="stylesheet" href="/static/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/syntax.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/static/css/toc.css">
    <script type="text/javascript" src="/static/js/jquery.toc.js"></script>
</head>
<body>
<nav class="navbar navbar-default top_menu" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">웹Frameworks</a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/getstarted">Get Started</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/updates">Update</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/tutorials">Tutorials</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/quickstart">Quick Start</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/archives">Archives</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="https://github.com/KoreaHTML5/webframeworks.kr/blob/master/CONTRIBUTE.md" target="_blank">참여하기</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="http://goo.gl/forms/MB9ZxVvdrD" target="_blank">설문하기</a></li>
            </ul>
        </div>
    </div>
</nav>


<div class="content_bg"  style="background-color: #;color: #;" >
<div class="col-md-10 col-md-offset-1 title_header jumbotron"  style="background:url() no-repeat center"  >
<h1 class="title_header_title">Express로 Google AdSense 보고서 작성하기</h1>
<p class="title_header_summary">Express로 Google AdSense 보고서 작성하는 방법에 대해 알아봅니다.</p>
</div>
</div>

<div>

    <div class="col-sm-3 col-md-2 col-md-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">작성자</h3>
            </div>
            <div class="panel-body">
                <div class="media">
                    <a class="pull-left" href="#">
                        <img class="media-object profile_img" src="https://avatars2.githubusercontent.com/u/2951094?s=400&u=444fd9e324854bf6615b6f14239a67d878289998&v=4" alt="조덕기">
                    </a>
                    <div class="media-body">
                        <h4 class="media-heading">
                            조덕기

                        </h4>
                        DanielCho<br>
                    </div>
                </div>
            </div>
        </div>

        <div id="toc_location"></div>

        <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Tags</h3>
    </div>
    <div class="panel-body">
        <a href='/tags/jquery/' style='color: rgba(0,0,0,0.056281)'>jquery</a>
<a href='/tags/javascript/' style='color: rgba(0,0,0,8.667210)'>javascript</a>
<a href='/tags/html/' style='color: rgba(0,0,0,0.056281)'>html</a>
<a href='/tags/grunt/' style='color: rgba(0,0,0,0.056281)'>grunt</a>
<a href='/tags/gulp/' style='color: rgba(0,0,0,0.056281)'>gulp</a>
<a href='/tags/build/' style='color: rgba(0,0,0,0.337684)'>build</a>
<a href='/tags/yeoman/' style='color: rgba(0,0,0,0.056281)'>yeoman</a>
<a href='/tags/foundation/' style='color: rgba(0,0,0,0.056281)'>foundation</a>
<a href='/tags/bower/' style='color: rgba(0,0,0,0.112561)'>bower</a>
<a href='/tags/twitter/' style='color: rgba(0,0,0,0.112561)'>twitter</a>
<a href='/tags/framework/' style='color: rgba(0,0,0,2.194943)'>framework</a>
<a href='/tags/angularjs/' style='color: rgba(0,0,0,0.956770)'>angularjs</a>
<a href='/tags/tutorials/' style='color: rgba(0,0,0,1.238173)'>tutorials</a>
<a href='/tags/backbone/' style='color: rgba(0,0,0,0.225122)'>backbone</a>
<a href='/tags/getstarted/' style='color: rgba(0,0,0,0.168842)'>getstarted</a>
<a href='/tags/underscore/' style='color: rgba(0,0,0,0.056281)'>underscore</a>
<a href='/tags/library/' style='color: rgba(0,0,0,0.393964)'>library</a>
<a href='/tags/Ext/' style='color: rgba(0,0,0,0.506525)'>Ext</a>
<a href='/tags/JS/' style='color: rgba(0,0,0,0.787928)'>JS</a>
<a href='/tags/tutorial/' style='color: rgba(0,0,0,0.731648)'>tutorial</a>
<a href='/tags/modernizr/' style='color: rgba(0,0,0,0.056281)'>modernizr</a>
<a href='/tags/bootstrap/' style='color: rgba(0,0,0,0.168842)'>bootstrap</a>
<a href='/tags/quickstart/' style='color: rgba(0,0,0,0.056281)'>quickstart</a>
<a href='/tags/angular-di/' style='color: rgba(0,0,0,0.056281)'>angular-di</a>
<a href='/tags/animation/' style='color: rgba(0,0,0,0.225122)'>animation</a>
<a href='/tags/router/' style='color: rgba(0,0,0,0.056281)'>router</a>
<a href='/tags/promise/' style='color: rgba(0,0,0,0.281403)'>promise</a>
<a href='/tags/responsive/' style='color: rgba(0,0,0,0.056281)'>responsive</a>
<a href='/tags/form/' style='color: rgba(0,0,0,0.112561)'>form</a>
<a href='/tags/validation/' style='color: rgba(0,0,0,0.112561)'>validation</a>
<a href='/tags/map/' style='color: rgba(0,0,0,0.056281)'>map</a>
<a href='/tags/direcitve/' style='color: rgba(0,0,0,0.056281)'>direcitve</a>
<a href='/tags/file/' style='color: rgba(0,0,0,0.112561)'>file</a>
<a href='/tags/test/' style='color: rgba(0,0,0,0.225122)'>test</a>
<a href='/tags/ui-bootstrap/' style='color: rgba(0,0,0,0.056281)'>ui-bootstrap</a>
<a href='/tags/twitter-bootstrap/' style='color: rgba(0,0,0,0.056281)'>twitter-bootstrap</a>
<a href='/tags/express/' style='color: rgba(0,0,0,0.112561)'>express</a>
<a href='/tags/express.js/' style='color: rgba(0,0,0,0.056281)'>express.js</a>
<a href='/tags/node.js/' style='color: rgba(0,0,0,0.225122)'>node.js</a>
<a href='/tags/backend/' style='color: rgba(0,0,0,0.168842)'>backend</a>
<a href='/tags/d3.js/' style='color: rgba(0,0,0,0.056281)'>d3.js</a>
<a href='/tags/visualization/' style='color: rgba(0,0,0,0.056281)'>visualization</a>
<a href='/tags/reactjs/' style='color: rgba(0,0,0,0.112561)'>reactjs</a>
<a href='/tags/expressjs/' style='color: rgba(0,0,0,0.393964)'>expressjs</a>
<a href='/tags/react/' style='color: rgba(0,0,0,1.238173)'>react</a>
<a href='/tags/session/' style='color: rgba(0,0,0,0.112561)'>session</a>
<a href='/tags/meteor/' style='color: rgba(0,0,0,0.787928)'>meteor</a>
<a href='/tags/SEO/' style='color: rgba(0,0,0,0.056281)'>SEO</a>
<a href='/tags/REST/' style='color: rgba(0,0,0,0.056281)'>REST</a>
<a href='/tags/API/' style='color: rgba(0,0,0,0.056281)'>API</a>
<a href='/tags/es2015/' style='color: rgba(0,0,0,0.112561)'>es2015</a>
<a href='/tags/es6/' style='color: rgba(0,0,0,0.619086)'>es6</a>
<a href='/tags/es7/' style='color: rgba(0,0,0,0.112561)'>es7</a>
<a href='/tags/DDP/' style='color: rgba(0,0,0,0.056281)'>DDP</a>
<a href='/tags/ngMessages/' style='color: rgba(0,0,0,0.112561)'>ngMessages</a>
<a href='/tags/jsx/' style='color: rgba(0,0,0,0.056281)'>jsx</a>
<a href='/tags/publish/' style='color: rgba(0,0,0,0.056281)'>publish</a>
<a href='/tags/subscribe/' style='color: rgba(0,0,0,0.056281)'>subscribe</a>
<a href='/tags/meteor.js/' style='color: rgba(0,0,0,0.056281)'>meteor.js</a>
<a href='/tags/reactive/' style='color: rgba(0,0,0,0.056281)'>reactive</a>
<a href='/tags/package/' style='color: rgba(0,0,0,0.056281)'>package</a>
<a href='/tags/static/' style='color: rgba(0,0,0,0.056281)'>static</a>
<a href='/tags/assets/' style='color: rgba(0,0,0,0.056281)'>assets</a>
<a href='/tags/public/' style='color: rgba(0,0,0,0.056281)'>public</a>
<a href='/tags/flux/' style='color: rgba(0,0,0,0.225122)'>flux</a>
<a href='/tags/redux/' style='color: rgba(0,0,0,0.393964)'>redux</a>
<a href='/tags/server/' style='color: rgba(0,0,0,0.056281)'>server</a>
<a href='/tags/distribution/' style='color: rgba(0,0,0,0.056281)'>distribution</a>
<a href='/tags/webpack/' style='color: rgba(0,0,0,0.168842)'>webpack</a>
<a href='/tags/development/' style='color: rgba(0,0,0,0.056281)'>development</a>
<a href='/tags/optimization/' style='color: rgba(0,0,0,0.056281)'>optimization</a>
<a href='/tags/immutable/' style='color: rgba(0,0,0,0.056281)'>immutable</a>
<a href='/tags/orm/' style='color: rgba(0,0,0,0.225122)'>orm</a>
<a href='/tags/database/' style='color: rgba(0,0,0,0.225122)'>database</a>
<a href='/tags/hapi.js/' style='color: rgba(0,0,0,0.056281)'>hapi.js</a>
<a href='/tags/hapi/' style='color: rgba(0,0,0,0.225122)'>hapi</a>
<a href='/tags/ionic/' style='color: rgba(0,0,0,0.112561)'>ionic</a>
<a href='/tags/hybrid-app/' style='color: rgba(0,0,0,0.056281)'>hybrid-app</a>
<a href='/tags/django/' style='color: rgba(0,0,0,0.056281)'>django</a>
<a href='/tags/fullstack/' style='color: rgba(0,0,0,0.056281)'>fullstack</a>
<a href='/tags/spa/' style='color: rgba(0,0,0,0.056281)'>spa</a>
<a href='/tags/ExpressJS/' style='color: rgba(0,0,0,0.281403)'>ExpressJS</a>
<a href='/tags/NodeJS/' style='color: rgba(0,0,0,0.281403)'>NodeJS</a>
<a href='/tags/Sequelize/' style='color: rgba(0,0,0,0.281403)'>Sequelize</a>
<a href='/tags/Mocha/' style='color: rgba(0,0,0,0.281403)'>Mocha</a>
<a href='/tags/Supertest/' style='color: rgba(0,0,0,0.281403)'>Supertest</a>
<a href='/tags/UnitTest/' style='color: rgba(0,0,0,0.281403)'>UnitTest</a>
<a href='/tags/this/' style='color: rgba(0,0,0,0.112561)'>this</a>
<a href='/tags/dom/' style='color: rgba(0,0,0,0.056281)'>dom</a>
<a href='/tags/es5/' style='color: rgba(0,0,0,0.112561)'>es5</a>
<a href='/tags/virtualdom/' style='color: rgba(0,0,0,0.112561)'>virtualdom</a>
<a href='/tags/modules/' style='color: rgba(0,0,0,0.056281)'>modules</a>
<a href='/tags/asynchronous/' style='color: rgba(0,0,0,0.056281)'>asynchronous</a>
<a href='/tags/semicolon/' style='color: rgba(0,0,0,0.056281)'>semicolon</a>
<a href='/tags/nodejs/' style='color: rgba(0,0,0,0.056281)'>nodejs</a>
<a href='/tags/ECMAScript2015/' style='color: rgba(0,0,0,0.112561)'>ECMAScript2015</a>
<a href='/tags/babel/' style='color: rgba(0,0,0,0.056281)'>babel</a>
<a href='/tags/angular,/' style='color: rgba(0,0,0,0.056281)'>angular,</a>
<a href='/tags/electron/' style='color: rgba(0,0,0,0.112561)'>electron</a>
<a href='/tags/docker/' style='color: rgba(0,0,0,0.281403)'>docker</a>
<a href='/tags/D3/' style='color: rgba(0,0,0,0.056281)'>D3</a>
<a href='/tags/node/' style='color: rgba(0,0,0,0.112561)'>node</a>
<a href='/tags/aws/' style='color: rgba(0,0,0,1.350734)'>aws</a>
<a href='/tags/dynamoDB/' style='color: rgba(0,0,0,0.056281)'>dynamoDB</a>
<a href='/tags/chrome/' style='color: rgba(0,0,0,0.056281)'>chrome</a>
<a href='/tags/native/' style='color: rgba(0,0,0,0.112561)'>native</a>
<a href='/tags/markdown/' style='color: rgba(0,0,0,0.056281)'>markdown</a>
<a href='/tags/vue/' style='color: rgba(0,0,0,2.082382)'>vue</a>
<a href='/tags/middleware/' style='color: rgba(0,0,0,0.056281)'>middleware</a>
<a href='/tags/IoT/' style='color: rgba(0,0,0,0.056281)'>IoT</a>
<a href='/tags/serverless/' style='color: rgba(0,0,0,0.056281)'>serverless</a>
<a href='/tags/python/' style='color: rgba(0,0,0,0.168842)'>python</a>
<a href='/tags/socket.io/' style='color: rgba(0,0,0,0.168842)'>socket.io</a>
<a href='/tags/typescript/' style='color: rgba(0,0,0,0.056281)'>typescript</a>
<a href='/tags/laravel/' style='color: rgba(0,0,0,1.407015)'>laravel</a>

    </div>
</div>
    </div>

    <div class="col-sm-9 col-md-6">
        <div class="media_content media_item shadow_panel" id="main_content">
            <blockquote>
<p>본 포스팅은 <a href="http://cmichel.io/">Christoph Michel</a> 의 <a href="http://cmichel.io/creating-google-adsense-reports-with-express/">Creating Google AdSense Reports with Express</a> 를 저자의 허락하에 번역한 글입니다. 오탈자, 오역 등이 있다면 연락부탁드립니다.</p>
</blockquote>

<p>필자는 필자의 앱들의 AdMob 수익에 대한 일일 보고서를 <a href="https://pushover.net/">PushOver Notification Service</a>를 사용하여 휴대폰으로 보내고 싶었지만, Node.js와 Express.js를 사용하여 Google AdSense (+AdMob) 수익 정보를 가져오는 어떠한 예제/사례도 찾을 수 없었다. 대부분의 다른 언어는 <a href="https://developers.google.com/adsense/management/libraries">코드 예제</a>가 있었지만 Google-API-NodeJS-Client에 대해서는 없었기 때문에, 본 포스팅에서는 이를 다루려고 한다.</p>

<h2>설정하기</h2>

<p>우리는 <a href="https://github.com/google/google-api-nodejs-client">google-api-nodejs-client</a>을 사용하려고 하며, 이를 OAuth로 인증하려고 한다. 당신이 이미 Google 개발자 콘솔에서 웹 응용 프로그램을 설치했고, AdSense 관리 API를 추가하였으며, 증명서(credentials)을 만들었다고 가정하겠다. (테스트 목적으로 당신은  <em>localhost</em> 증명서를 만들 수 있다.) 증명서를 <em>.json</em> 파일 형태로 다운로드한다. (<em>clientsecret.apps.googleusercontent.com</em>). <a href="https://developers.google.com/adsense/management/getting_started">Getting Started</a> 가이드를 읽어보는 것도 도움이 된다. 우선, 새 프로젝트를 만들고 <em>npm install --save express googleapis</em> 를 사용하여 <em>dependencies</em>를 설치한다.</p>

<h2>인증하기</h2>

<p>Express.js 응용 프로그램에서 인증하기 위해서 Google OAuth를 사용한다. 그러므로, 우리는 엑세스(<em>adsense.readonly</em>)의 범위를 정의하고 Google 승인 페이지, 즉 접근 허가 페이지로 다시 보내는 경로(<em>/auth/google</em>)를 제공한다. 사용자가 확인을 하면, Google은 인증 토큰을 증명서(<em>redirect_uris</em>) 파일에서 정의된 <em>callback</em> 경로로 보낸다. 걱정하지 마라. <em>refresh_token</em>을 받기 위해서 한번만 수동으로 인증하면 된다. 그것을 저장하고 엑세스 토큰이 만료되면 항상 새롭게 요청할 수 있다. </p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="nx">google</span> <span class="nx">from</span> <span class="s1">&#39;googleapis&#39;</span>
<span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./client_secret_*.apps.googleusercontent.com.json&#39;</span><span class="p">).</span><span class="nx">web</span>

<span class="kr">const</span> <span class="nx">scope</span> <span class="o">=</span> <span class="s1">&#39;https://www.googleapis.com/auth/adsense.readonly&#39;</span>

<span class="kr">const</span> <span class="nx">oauth2Client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">OAuth2</span><span class="p">(</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">client_id</span><span class="p">,</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">client_secret</span><span class="p">,</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">redirect_uris</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1">// may NOT be an array. Otherwise, the consent site works, but silently fails in getToken.</span>
<span class="p">)</span>

<span class="kr">const</span> <span class="nx">consentURL</span> <span class="o">=</span> <span class="nx">oauth2Client</span><span class="p">.</span><span class="nx">generateAuthUrl</span><span class="p">({</span>
  <span class="nx">access_type</span><span class="o">:</span> <span class="s1">&#39;offline&#39;</span><span class="p">,</span> <span class="c1">// &#39;online&#39; (default) or &#39;offline&#39; (gets refresh_token)</span>
  <span class="nx">scope</span><span class="p">,</span>  <span class="c1">// If you only need one scope you can pass it as string</span>
  <span class="nx">prompt</span><span class="o">:</span> <span class="s1">&#39;consent&#39;</span><span class="p">,</span>    <span class="c1">// always prompt for consent</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth/google&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">consentURL</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// oauth2callback as defined in config.redirect_uris[0] in the Google Dev Console</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/oauth2callback&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">getTokens</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span>
<span class="p">(</span><span class="nx">tokens</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// save tokens somewhere in a DB or a file</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">Received</span> <span class="nx">code</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">}</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;</span><span class="nx">Tokens</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)}</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;</span><span class="nx">Save</span> <span class="nx">them</span><span class="p">.)</span>
<span class="p">},</span>
<span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">Received</span> <span class="nx">an</span> <span class="nx">error</span> <span class="k">while</span> <span class="nx">trying</span> <span class="nx">to</span> <span class="nx">get</span> <span class="nx">tokens</span> <span class="kd">with</span> <span class="nx">code</span> <span class="nx">$</span><span class="p">{</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">}</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">}</span><span class="err">\</span><span class="nx">n$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">)}),</span>
  <span class="p">)</span>
<span class="p">})</span>

<span class="kd">function</span> <span class="nx">getTokens</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">sucCallback</span><span class="p">,</span> <span class="nx">errCallback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">oauth2Client</span><span class="p">.</span><span class="nx">getToken</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// set the tokens here for future API requests</span>
  <span class="nx">oauth2Client</span><span class="p">.</span><span class="nx">setCredentials</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)</span>
  <span class="nx">sucCallback</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">errCallback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
<span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h2>AdSense 보고서 데이터 가져오기</h2>

<p>클라이언트가 인증되고 토큰이 설정되면, 당신은 <em>googleapis</em>의 <em>adsense</em> API 를 사용하여 당신의 수익 데이터를 가져올 수 있다. 필요한 경우 만료된 엑세스 토큰은 <em>oauth2Client.getAccessToken(callback)</em>에서 처리되어 업데이트할 수 있다. 당신은 시작일과 종료일을 지정하여 쿼리를 맞춤 설정할 수 있고, 또는 <em>dimension</em>을 설정하여 총 수익을 개별 광고로 나눌 수 있다. AdSense API를 어떻게 사용하는지 확인하고, 이런저런 기능을 확인해보기 위해서는 <a href="https://developers.google.com/adsense/management/v1.4/reference/accounts/reports/generate">해당 문서</a>를 참고하는게 좋다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// make sure oauth2Client&#39;s credentials are set</span>
<span class="c1">// with oauth2Client.setCredentials(tokens) as in getTokens</span>
<span class="c1">// or somewhere else with the saved tokens</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/adsense&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">getLatestReport</span><span class="p">(</span>
<span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reportString</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// Send error per push notification, E-Mail etc.</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="c1">// Send report per push notification, E-Mail etc.</span>
<span class="c1">// send(reportString)</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="p">})</span>

<span class="kd">function</span> <span class="nx">getLatestReport</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">adsense</span> <span class="o">=</span> <span class="nx">google</span><span class="p">.</span><span class="nx">adsense</span><span class="p">(</span><span class="s1">&#39;v1.4&#39;</span><span class="p">)</span>
  <span class="c1">// Get a non-expired access token, after refreshing if necessary https://github.com/google/google-auth-library-nodejs/blob/master/lib/auth/oauth2client.js</span>
  <span class="nx">oauth2Client</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">callback</span><span class="p">(</span><span class="nx">getAccessToken</span> <span class="nb">Error</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">})</span>
  <span class="k">return</span>
<span class="p">}</span>
<span class="c1">// create report for yesterday. Today&#39;s revenue info is still inaccurate</span>
<span class="kr">const</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;days&#39;</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">accountId</span><span class="o">:</span> <span class="s1">&#39;pub-58**************&#39;</span><span class="p">,</span>
  <span class="nx">startDate</span><span class="o">:</span> <span class="nx">date</span><span class="p">,</span>
  <span class="nx">endDate</span><span class="o">:</span> <span class="nx">date</span><span class="p">,</span>
  <span class="nx">auth</span><span class="o">:</span> <span class="nx">oauth2Client</span><span class="p">,</span>
  <span class="nx">metric</span><span class="o">:</span> <span class="s1">&#39;EARNINGS&#39;</span><span class="p">,</span>   <span class="c1">// https://developers.google.com/adsense/management/metrics-dimensions</span>
  <span class="nx">dimension</span><span class="o">:</span> <span class="s1">&#39;AD_UNIT_NAME&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">adsense</span><span class="p">.</span><span class="nx">accounts</span><span class="p">.</span><span class="nx">reports</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">errReport</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">errReport</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">callback</span><span class="p">(</span><span class="nx">errReport</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">reportToString</span><span class="p">(</span><span class="nx">resp</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">reportToString</span><span class="p">(</span><span class="nx">report</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">report</span><span class="p">.</span><span class="nx">endDate</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">AdMob</span> <span class="nx">Income</span> <span class="k">for</span> <span class="nx">$</span><span class="p">{</span><span class="nx">date</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;dddd MMM Do&#39;</span><span class="p">)}</span><span class="o">:</span>
  <span class="kr">const</span> <span class="nx">numRows</span> <span class="o">=</span> <span class="nx">report</span><span class="p">.</span><span class="nx">totalMatchedRows</span>
  <span class="kr">const</span> <span class="nx">rows</span> <span class="o">=</span> <span class="nx">report</span><span class="p">.</span><span class="nx">rows</span>
  <span class="kr">const</span> <span class="nx">currency</span> <span class="o">=</span> <span class="nx">report</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;EARNINGS&#39;</span><span class="p">).</span><span class="nx">currency</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numRows</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// This depends on your naming convention of your Ad units</span>
<span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">earnings</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="nx">response</span> <span class="o">+=</span> <span class="err">\</span><span class="nx">n$</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">earnings</span><span class="p">}</span><span class="nx">$</span><span class="p">{</span><span class="nx">currency</span><span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// console.log(report)</span>
  <span class="nx">response</span> <span class="o">+=</span> <span class="err">\</span><span class="nx">nTotal</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">report</span><span class="p">.</span><span class="nx">totals</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span><span class="nx">$</span><span class="p">{</span><span class="nx">currency</span><span class="p">}</span>
  <span class="k">return</span> <span class="nx">response</span>
<span class="p">}</span>
</code></pre></div>
<p>필자는 <em>cronjob</em>을 하루에 돌린다. 즉, 이를 사용하여 PushOver가 노티피케이션으로 보고서를 전달해주는 스크립트에 하루에 한번 접근한다. 그 출력은 다음과 같다:</p>

<p><img src="http://cmichel.io/creating-google-adsense-reports-with-express/google-pushover-adsense-reports.png" alt=""></p>

        </div>

        <div class="media_content media_item shadow_panel">
            <p>Tags : <a href="/tags/node">node</a>&nbsp;<a href="/tags/express">express</a>&nbsp;</p>
        </div>


        <div class="media_content media_item shadow_panel">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'html5krforkisa'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
        </div>

    </div>

    <script>
        $('#main_content').toc();
    </script>
</div>
<footer>
<table width="100%" height="80" class="footer">
    <tr>
        <td align="center" class="footer_content">
            WebFrameworks.kr @since 2015
        </td>
    </tr>
</table>
</footer>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56520981-1', 'auto');
    ga('send', 'pageview');

</script>
</body>
</html>