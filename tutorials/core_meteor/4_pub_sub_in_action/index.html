<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<style>
@import url(https://fonts.googleapis.com/earlyaccess/nanumgothic.css); /* 나눔고딕 : 'Nanum Gothic' */
</style>
<title>WebFrameworks.kr - Pub/Sub 어디까지 써봤니</title>
<link rel="stylesheet" href="/static/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/syntax.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/static/css/toc.css">
    <script type="text/javascript" src="/static/js/jquery.toc.js"></script>
</head>
<body>
<nav class="navbar navbar-default top_menu" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">웹Frameworks</a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/getstarted">Get Started</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/updates">Update</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/tutorials">Tutorials</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/quickstart">Quick Start</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="/archives">Archives</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="https://github.com/KoreaHTML5/webframeworks.kr/blob/master/CONTRIBUTE.md" target="_blank">참여하기</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-left">
                <li><a href="http://goo.gl/forms/MB9ZxVvdrD" target="_blank">설문하기</a></li>
            </ul>
        </div>
    </div>
</nav>


<div class="content_bg"  style="background-color: #1C1C1F;color: #E4E4E4;" >
<div class="col-md-10 col-md-offset-1 title_header jumbotron"  style="background:url() no-repeat center"  >
<h1 class="title_header_title">Pub/Sub 어디까지 써봤니</h1>
<p class="title_header_summary">Mongodb를 사용하지 않고서도 구독과 발행을 자유롭게 사용하는 패턴들을 보자.</p>
</div>
</div>

<div>

    <div class="col-sm-3 col-md-2 col-md-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">작성자</h3>
            </div>
            <div class="panel-body">
                <div class="media">
                    <a class="pull-left" href="#">
                        <img class="media-object profile_img" src="https://avatars0.githubusercontent.com/u/623157?v=3&s=460" alt="이재호">
                    </a>
                    <div class="media-body">
                        <h4 class="media-heading">
                            이재호

                        </h4>
                        acidsound<br>
                    </div>
                </div>
            </div>
        </div>

        <div id="toc_location"></div>

        <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Tags</h3>
    </div>
    <div class="panel-body">
        <a href='/tags/jquery/' style='color: rgba(0,0,0,0.062316)'>jquery</a>
<a href='/tags/javascript/' style='color: rgba(0,0,0,8.661949)'>javascript</a>
<a href='/tags/html/' style='color: rgba(0,0,0,0.062316)'>html</a>
<a href='/tags/grunt/' style='color: rgba(0,0,0,0.062316)'>grunt</a>
<a href='/tags/gulp/' style='color: rgba(0,0,0,0.062316)'>gulp</a>
<a href='/tags/build/' style='color: rgba(0,0,0,0.373897)'>build</a>
<a href='/tags/yeoman/' style='color: rgba(0,0,0,0.062316)'>yeoman</a>
<a href='/tags/foundation/' style='color: rgba(0,0,0,0.062316)'>foundation</a>
<a href='/tags/bower/' style='color: rgba(0,0,0,0.124632)'>bower</a>
<a href='/tags/twitter/' style='color: rgba(0,0,0,0.124632)'>twitter</a>
<a href='/tags/framework/' style='color: rgba(0,0,0,2.368015)'>framework</a>
<a href='/tags/angularjs/' style='color: rgba(0,0,0,1.059375)'>angularjs</a>
<a href='/tags/tutorials/' style='color: rgba(0,0,0,1.370956)'>tutorials</a>
<a href='/tags/backbone/' style='color: rgba(0,0,0,0.249265)'>backbone</a>
<a href='/tags/getstarted/' style='color: rgba(0,0,0,0.186949)'>getstarted</a>
<a href='/tags/underscore/' style='color: rgba(0,0,0,0.062316)'>underscore</a>
<a href='/tags/library/' style='color: rgba(0,0,0,0.436213)'>library</a>
<a href='/tags/Ext/' style='color: rgba(0,0,0,0.560846)'>Ext</a>
<a href='/tags/JS/' style='color: rgba(0,0,0,0.872426)'>JS</a>
<a href='/tags/tutorial/' style='color: rgba(0,0,0,0.810110)'>tutorial</a>
<a href='/tags/modernizr/' style='color: rgba(0,0,0,0.062316)'>modernizr</a>
<a href='/tags/bootstrap/' style='color: rgba(0,0,0,0.186949)'>bootstrap</a>
<a href='/tags/quickstart/' style='color: rgba(0,0,0,0.062316)'>quickstart</a>
<a href='/tags/angular-di/' style='color: rgba(0,0,0,0.062316)'>angular-di</a>
<a href='/tags/animation/' style='color: rgba(0,0,0,0.249265)'>animation</a>
<a href='/tags/router/' style='color: rgba(0,0,0,0.062316)'>router</a>
<a href='/tags/promise/' style='color: rgba(0,0,0,0.311581)'>promise</a>
<a href='/tags/responsive/' style='color: rgba(0,0,0,0.062316)'>responsive</a>
<a href='/tags/form/' style='color: rgba(0,0,0,0.124632)'>form</a>
<a href='/tags/validation/' style='color: rgba(0,0,0,0.124632)'>validation</a>
<a href='/tags/map/' style='color: rgba(0,0,0,0.062316)'>map</a>
<a href='/tags/direcitve/' style='color: rgba(0,0,0,0.062316)'>direcitve</a>
<a href='/tags/file/' style='color: rgba(0,0,0,0.124632)'>file</a>
<a href='/tags/test/' style='color: rgba(0,0,0,0.249265)'>test</a>
<a href='/tags/ui-bootstrap/' style='color: rgba(0,0,0,0.062316)'>ui-bootstrap</a>
<a href='/tags/twitter-bootstrap/' style='color: rgba(0,0,0,0.062316)'>twitter-bootstrap</a>
<a href='/tags/express/' style='color: rgba(0,0,0,0.124632)'>express</a>
<a href='/tags/express.js/' style='color: rgba(0,0,0,0.062316)'>express.js</a>
<a href='/tags/node.js/' style='color: rgba(0,0,0,0.249265)'>node.js</a>
<a href='/tags/backend/' style='color: rgba(0,0,0,0.186949)'>backend</a>
<a href='/tags/d3.js/' style='color: rgba(0,0,0,0.062316)'>d3.js</a>
<a href='/tags/visualization/' style='color: rgba(0,0,0,0.062316)'>visualization</a>
<a href='/tags/reactjs/' style='color: rgba(0,0,0,0.124632)'>reactjs</a>
<a href='/tags/expressjs/' style='color: rgba(0,0,0,0.436213)'>expressjs</a>
<a href='/tags/react/' style='color: rgba(0,0,0,1.370956)'>react</a>
<a href='/tags/session/' style='color: rgba(0,0,0,0.124632)'>session</a>
<a href='/tags/meteor/' style='color: rgba(0,0,0,0.872426)'>meteor</a>
<a href='/tags/SEO/' style='color: rgba(0,0,0,0.062316)'>SEO</a>
<a href='/tags/REST/' style='color: rgba(0,0,0,0.062316)'>REST</a>
<a href='/tags/API/' style='color: rgba(0,0,0,0.062316)'>API</a>
<a href='/tags/es2015/' style='color: rgba(0,0,0,0.124632)'>es2015</a>
<a href='/tags/es6/' style='color: rgba(0,0,0,0.685478)'>es6</a>
<a href='/tags/es7/' style='color: rgba(0,0,0,0.124632)'>es7</a>
<a href='/tags/DDP/' style='color: rgba(0,0,0,0.062316)'>DDP</a>
<a href='/tags/ngMessages/' style='color: rgba(0,0,0,0.124632)'>ngMessages</a>
<a href='/tags/jsx/' style='color: rgba(0,0,0,0.062316)'>jsx</a>
<a href='/tags/publish/' style='color: rgba(0,0,0,0.062316)'>publish</a>
<a href='/tags/subscribe/' style='color: rgba(0,0,0,0.062316)'>subscribe</a>
<a href='/tags/meteor.js/' style='color: rgba(0,0,0,0.062316)'>meteor.js</a>
<a href='/tags/reactive/' style='color: rgba(0,0,0,0.062316)'>reactive</a>
<a href='/tags/package/' style='color: rgba(0,0,0,0.062316)'>package</a>
<a href='/tags/static/' style='color: rgba(0,0,0,0.062316)'>static</a>
<a href='/tags/assets/' style='color: rgba(0,0,0,0.062316)'>assets</a>
<a href='/tags/public/' style='color: rgba(0,0,0,0.062316)'>public</a>
<a href='/tags/flux/' style='color: rgba(0,0,0,0.249265)'>flux</a>
<a href='/tags/redux/' style='color: rgba(0,0,0,0.436213)'>redux</a>
<a href='/tags/server/' style='color: rgba(0,0,0,0.062316)'>server</a>
<a href='/tags/distribution/' style='color: rgba(0,0,0,0.062316)'>distribution</a>
<a href='/tags/webpack/' style='color: rgba(0,0,0,0.186949)'>webpack</a>
<a href='/tags/development/' style='color: rgba(0,0,0,0.062316)'>development</a>
<a href='/tags/optimization/' style='color: rgba(0,0,0,0.062316)'>optimization</a>
<a href='/tags/immutable/' style='color: rgba(0,0,0,0.062316)'>immutable</a>
<a href='/tags/orm/' style='color: rgba(0,0,0,0.249265)'>orm</a>
<a href='/tags/database/' style='color: rgba(0,0,0,0.249265)'>database</a>
<a href='/tags/hapi.js/' style='color: rgba(0,0,0,0.062316)'>hapi.js</a>
<a href='/tags/hapi/' style='color: rgba(0,0,0,0.249265)'>hapi</a>
<a href='/tags/ionic/' style='color: rgba(0,0,0,0.124632)'>ionic</a>
<a href='/tags/hybrid-app/' style='color: rgba(0,0,0,0.062316)'>hybrid-app</a>
<a href='/tags/django/' style='color: rgba(0,0,0,0.062316)'>django</a>
<a href='/tags/fullstack/' style='color: rgba(0,0,0,0.062316)'>fullstack</a>
<a href='/tags/spa/' style='color: rgba(0,0,0,0.062316)'>spa</a>
<a href='/tags/ExpressJS/' style='color: rgba(0,0,0,0.311581)'>ExpressJS</a>
<a href='/tags/NodeJS/' style='color: rgba(0,0,0,0.311581)'>NodeJS</a>
<a href='/tags/Sequelize/' style='color: rgba(0,0,0,0.311581)'>Sequelize</a>
<a href='/tags/Mocha/' style='color: rgba(0,0,0,0.311581)'>Mocha</a>
<a href='/tags/Supertest/' style='color: rgba(0,0,0,0.311581)'>Supertest</a>
<a href='/tags/UnitTest/' style='color: rgba(0,0,0,0.311581)'>UnitTest</a>
<a href='/tags/this/' style='color: rgba(0,0,0,0.124632)'>this</a>
<a href='/tags/dom/' style='color: rgba(0,0,0,0.062316)'>dom</a>
<a href='/tags/es5/' style='color: rgba(0,0,0,0.124632)'>es5</a>
<a href='/tags/virtualdom/' style='color: rgba(0,0,0,0.124632)'>virtualdom</a>
<a href='/tags/modules/' style='color: rgba(0,0,0,0.062316)'>modules</a>
<a href='/tags/asynchronous/' style='color: rgba(0,0,0,0.062316)'>asynchronous</a>
<a href='/tags/semicolon/' style='color: rgba(0,0,0,0.062316)'>semicolon</a>
<a href='/tags/nodejs/' style='color: rgba(0,0,0,0.062316)'>nodejs</a>
<a href='/tags/ECMAScript2015/' style='color: rgba(0,0,0,0.124632)'>ECMAScript2015</a>
<a href='/tags/babel/' style='color: rgba(0,0,0,0.062316)'>babel</a>
<a href='/tags/angular,/' style='color: rgba(0,0,0,0.062316)'>angular,</a>
<a href='/tags/electron/' style='color: rgba(0,0,0,0.062316)'>electron</a>
<a href='/tags/D3/' style='color: rgba(0,0,0,0.062316)'>D3</a>
<a href='/tags/node/' style='color: rgba(0,0,0,0.124632)'>node</a>
<a href='/tags/aws/' style='color: rgba(0,0,0,0.186949)'>aws</a>
<a href='/tags/dynamoDB/' style='color: rgba(0,0,0,0.062316)'>dynamoDB</a>
<a href='/tags/chrome/' style='color: rgba(0,0,0,0.062316)'>chrome</a>
<a href='/tags/native/' style='color: rgba(0,0,0,0.124632)'>native</a>
<a href='/tags/markdown/' style='color: rgba(0,0,0,0.062316)'>markdown</a>
<a href='/tags/vue/' style='color: rgba(0,0,0,2.243382)'>vue</a>
<a href='/tags/middleware/' style='color: rgba(0,0,0,0.062316)'>middleware</a>
<a href='/tags/IoT/' style='color: rgba(0,0,0,0.062316)'>IoT</a>
<a href='/tags/docker/' style='color: rgba(0,0,0,0.062316)'>docker</a>
<a href='/tags/serverless/' style='color: rgba(0,0,0,0.062316)'>serverless</a>
<a href='/tags/python/' style='color: rgba(0,0,0,0.186949)'>python</a>
<a href='/tags/socket.io/' style='color: rgba(0,0,0,0.186949)'>socket.io</a>

    </div>
</div>
    </div>

    <div class="col-sm-9 col-md-6">
        <div class="media_content media_item shadow_panel" id="main_content">
            <h1>[Core Meteor] Pub/Sub 어디까지 써봤니</h1>

<p>Meteor Document를 보면 publish(<a href="http://docs.meteor.com/#/full/meteor_publish">http://docs.meteor.com/#/full/meteor_publish</a>)
링크의 아래에 <a href="http://docs.meteor.com/#/full/publish_added">this.added</a>와 같은 함수들이 있다.</p>

<p>Meteor.subscribe한 컬렉션에서 observe를 해보면 added/changed/removed 를 받을 수 있는데
사실은 이는 publish에서 <strong>&quot;만들&quot;</strong>수 있는 것이다.</p>

<p>최초 publish 에 들어왔을 때 <code>this.ready()</code>를 한번 해주고 들어올 때 마다 publish에서 add를 해주는 식이다.</p>

<p>외부 API를 쓴다거나 TCP/UDP 연결해서 얻은 결과물을 Collection 형태로 받을 때 매우 유용하다.</p>

<p>그래서 MQTT pub/sub 연동 예제를 구현해보았다.</p>

<p><a href="http://meteorpad.com/pad/uGoYkgrkWxBbkfJhh/mqttMeteor">http://meteorpad.com/pad/uGoYkgrkWxBbkfJhh/mqttMeteor</a></p>

<p>이 예제에선 <code>test.mosquitto.org</code> 를 바라보고 MQTT 메시지를 수신하고 송신할 수 있다.</p>

<p>구현이 얼마 없는 것에 비해 매우 잘 작동하지 않는가?</p>

<p>MongoDB가 아닌 외부의 비동기 호출을 통해 받은 결과를 넘겨주는 것으로 실제 publish쪽 구현은 아주 간단한데</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&quot;chats&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="c1">// async function</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">instance</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s2">&quot;chats&quot;</span><span class="p">,</span> <span class="nx">Random</span><span class="p">.</span><span class="nx">id</span><span class="p">(),</span> <span class="p">{</span>
      <span class="nx">message</span><span class="o">:</span><span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
      <span class="nx">createdAt</span><span class="o">:</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>
<p>subscribe쪽에 collection이 준비되었음을 알리기 위해 <code>ready()</code>
<a href="http://docs.meteor.com/#/full/publish_ready">(http://docs.meteor.com/#/full/publish_ready)</a>를 호출하고
새로 데이터가 들어오면 added<a href="http://docs.meteor.com/#/full/publish_added">(http://docs.meteor.com/#/full/publish_added)</a>를 사용하는 것이 전부다.</p>

<p>added의 인자는 collection명, 중복구분용 id, 실제저장하고자 하는 객체 이렇게 세가지만 잘 넣어주면 된다.</p>

<p>만일 외부 API를 받아오고자 한다면 http package(meteor add http로 추가)를 추가한 후 <code>client.on</code> 부분을 <code>HTTP.get</code> 같은 걸로 대신하면 된다.</p>

<p>본 예와는 상관없지만 변경과 삭제의 경우도 마찬가지로 changed, removed를 사용한다.</p>

<p>실시간 데이터 변경을 감지하려면 해당 Collection을 observeChanges 감시하고 있다가 접근하면 된다.</p>

<p>특정 Collection의 count를 구현해 놓은 예를 한번 살펴보면서 알아보자.</p>

<p>먼저, 서버 쪽 예제를 보면</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// server: publish the current size of a collection</span>
<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s2">&quot;counts-by-room&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">roomId</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">check</span><span class="p">(</span><span class="nx">roomId</span><span class="p">,</span> <span class="nb">String</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">initializing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="c1">// observeChanges only returns after the initial `added` callbacks</span>
  <span class="c1">// have run. Until then, we don&#39;t want to send a lot of</span>
  <span class="c1">// `self.changed()` messages - hence tracking the</span>
  <span class="c1">// `initializing` state.</span>
  <span class="kd">var</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nx">Messages</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">roomId</span><span class="o">:</span> <span class="nx">roomId</span><span class="p">}).</span><span class="nx">observeChanges</span><span class="p">({</span>
    <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initializing</span><span class="p">)</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="nx">roomId</span><span class="p">,</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span> <span class="nx">count</span><span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">removed</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">--</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="nx">roomId</span><span class="p">,</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span> <span class="nx">count</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="c1">// don&#39;t care about changed</span>
  <span class="p">});</span>

  <span class="c1">// Instead, we&#39;ll send one `self.added()` message right after</span>
  <span class="c1">// observeChanges has returned, and mark the subscription as</span>
  <span class="c1">// ready.</span>
  <span class="nx">initializing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="nx">roomId</span><span class="p">,</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span> <span class="nx">count</span><span class="p">});</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>

  <span class="c1">// Stop observing the cursor when client unsubs.</span>
  <span class="c1">// Stopping a subscription automatically takes</span>
  <span class="c1">// care of sending the client any removed messages.</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">onStop</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">handle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>클라이언트에서와 같이 서버에서도 <code>observeChanges</code>를 사용할 수 있는데 변경 감지를 하고 실시간으로 pub/sub을 구현하기 위해
주의할 점 중 하나는 <code>observeChanges</code>에서 최초 subscribe가 일어나는 시점에 added를 감지하여 이중으로 added가 되는 것을 막아야한다.</p>

<p>위의 예에선 initializing 지역 변수를 사용하여 제어하였다.</p>

<p>최초 subscribe 시엔 added만 발생하므로</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initializing</span><span class="p">)</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="nx">roomId</span><span class="p">,</span> <span class="p">{</span><span class="nx">count</span><span class="o">:</span> <span class="nx">count</span><span class="p">});</span>
    <span class="p">},</span>
</code></pre></div>
<p>이와 같이 해당 부분에서만 체크한다.</p>

<p>마지막으로 subscribe 시 반환값으로 받은 핸들로 <code>stop()</code> 을 사용하거나 Template의 <code>onCreated</code> 안에서
<code>this.subscribe</code>로 가입한 경우 해당 템플릿이 사라질 경우 <code>onDestoryed</code> 과정에서 구독이 종료된다.</p>

<p>이때 반드시 publish 안에서 observeChanges의 핸들을 <code>this.onStop</code>으로 감시하여 중지해주자.</p>

<p>이렇게 만들어 놓은 Custom Publish는 클라이언트에서 사용할 땐 일반 Collection 처럼 다루면 된다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// client: declare collection to hold count object</span>
<span class="nx">Counts</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">);</span>

<span class="c1">// client: subscribe to the count for the current room</span>
<span class="nx">Tracker</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;counts-by-room&quot;</span><span class="p">,</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;roomId&quot;</span><span class="p">));</span>
<span class="p">});</span>

<span class="c1">// client: use the new collection</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Current room has &quot;</span> <span class="o">+</span>
            <span class="nx">Counts</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;roomId&quot;</span><span class="p">)).</span><span class="nx">count</span> <span class="o">+</span>
            <span class="s2">&quot; messages.&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Publish/Subscribe는 꼭 MongoDB에만 국한되지 않는다.</p>

<p>소켓 통신이나 파일, 큐등 다양한 실시간/배치 작업에 사용할 수 있으니 여러가지로 활용해보자.</p>

        </div>

        <div class="media_content media_item shadow_panel">
            <p>Tags : <a href="/tags/javascript">javascript</a>&nbsp;<a href="/tags/meteor">meteor</a>&nbsp;<a href="/tags/publish">publish</a>&nbsp;<a href="/tags/subscribe">subscribe</a>&nbsp;</p>
        </div>


        <div class="media_content media_item shadow_panel">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'html5krforkisa'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
        </div>

    </div>

    <script>
        $('#main_content').toc();
    </script>
</div>
<footer>
<table width="100%" height="80" class="footer">
    <tr>
        <td align="center" class="footer_content">
            WebFrameworks.kr @since 2015
        </td>
    </tr>
</table>
</footer>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56520981-1', 'auto');
    ga('send', 'pageview');

</script>
</body>
</html>